#+TITLE: Emacs configuration
#+PROPERTY: header-args:emacs-lisp :tangle .emacs.d/init.el :mkdirp yes

* Defaults
** Use package
#+BEGIN_SRC emacs-lisp
  (setq use-package-always-ensure t)
  (require 'package)
  (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
  (package-initialize)
#+END_SRC

** Sane modern file setup
#+BEGIN_SRC emacs-lisp
  ;; Raise GC threshold during init for faster startup
  (setq gc-cons-threshold most-positive-fixnum
        gc-cons-percentage 0.6)

  ;; After init, lower to a reasonable value for interactive use
  (add-hook 'emacs-startup-hook
            (lambda ()
              (setq gc-cons-threshold (* 16 1024 1024)  ; 16MB
                    gc-cons-percentage 0.1)))

  ;; GC when Emacs loses focus (debounced, skip during completion)
  (add-hook 'focus-out-hook
            (lambda ()
              (unless (or (active-minibuffer-window)
                          (bound-and-true-p company-candidates))
                (garbage-collect))))
#+END_SRC

** Display improvements
#+BEGIN_SRC emacs-lisp
  ;; redisplay-dont-pause is obsolete since Emacs 24.5 - removed
  ;; Optimize jit-lock for better fontification performance
  (setq jit-lock-stealth-time 1.25
        jit-lock-stealth-nice 0.5
        jit-lock-defer-time 0.05  ; Lower defer for snappier highlighting
        jit-lock-chunk-size 1000) ; Smaller chunks = more responsive
#+END_SRC

** Warn when opening files bigger than 100MB
#+BEGIN_SRC emacs-lisp
  (setq large-file-warning-threshold 100000000)
#+END_SRC

** Increase the amount of data which Emacs reads from a process
#+BEGIN_SRC emacs-lisp
  (setq read-process-output-max (* 5 1024 1024)
      process-adaptive-read-buffering nil)
#+END_SRC

** Encoding
#+BEGIN_SRC emacs-lisp
  (prefer-coding-system 'utf-8)
  (set-selection-coding-system 'utf-8)
#+END_SRC

** Good scrolling
#+begin_src emacs-lisp
  (use-package ultra-scroll
    :init
    (setq scroll-conservatively 3 ; or whatever value you prefer, since v0.4
          scroll-margin 0)
    :config
    (ultra-scroll-mode 1))
#+end_src

** Less verbose prompt
#+BEGIN_SRC emacs-lisp
  (defalias 'yes-or-no-p 'y-or-n-p)
  (setq xref-prompt-for-identifier nil
        comint-prompt-read-only t
        use-dialog-box nil)
#+END_SRC

** Better minibuffer completion keybind
#+begin_src emacs-lisp
  (define-key minibuffer-local-completion-map " " nil)
  (define-key minibuffer-local-must-match-map " " nil)
  (define-key minibuffer-local-completion-map "?" nil)
  (define-key minibuffer-local-must-match-map "?" nil)
  (define-key minibuffer-local-map (kbd "S-<return>") (lambda () (interactive) (insert "\n")))
  (add-hook 'minibuffer-setup-hook #'subword-mode)
#+end_src

** Avoid emacs littering
#+BEGIN_SRC emacs-lisp
  (setq backup-directory-alist `(("." . ,(expand-file-name "tmp/backups/" user-emacs-directory))))
  ;; auto-save-mode doesn't create the path automatically!
  (make-directory (expand-file-name "tmp/auto-saves/" user-emacs-directory) t)

  (setq auto-save-list-file-prefix (expand-file-name "tmp/auto-saves/sessions/" user-emacs-directory)
        auto-save-file-name-transforms `((".*" ,(expand-file-name "tmp/auto-saves/" user-emacs-directory) t)))
  (setq create-lockfiles nil)
  (setq projectile-known-projects-file (expand-file-name "tmp/projectile-bookmarks.eld" user-emacs-directory)
        lsp-session-file (expand-file-name "tmp/.lsp-session-v1" user-emacs-directory))

  (use-package no-littering)
#+END_SRC

** Bind arrow keys
#+BEGIN_SRC emacs-lisp
  (define-key key-translation-map (kbd "<up>") (kbd "C-p"))
  (define-key key-translation-map (kbd "<down>") (kbd "C-n"))
  (define-key key-translation-map (kbd "<left>") (kbd "C-b"))
  (define-key key-translation-map (kbd "<right>") (kbd "C-f"))
#+END_SRC

** Bind function keys
#+BEGIN_SRC emacs-lisp
  (define-key key-translation-map [f1] (kbd "C-1"))
  (define-key key-translation-map [f2] (kbd "C-2"))
  (define-key key-translation-map [f3] (kbd "C-3"))
  (define-key key-translation-map [f4] (kbd "C-4"))
  (define-key key-translation-map [f5] (kbd "C-5"))
  (define-key key-translation-map [f6] (kbd "C-6"))
  (define-key key-translation-map [f7] (kbd "C-7"))
  (define-key key-translation-map [f8] (kbd "C-8"))
  (define-key key-translation-map [f9] (kbd "C-9"))
  (define-key key-translation-map [f10] (kbd "C-0"))
#+END_SRC

** Buffers, frames & windows
#+BEGIN_SRC emacs-lisp
  ;; Auto-revert with performance optimizations
  (setq auto-revert-interval 1           ; Check every 1 second (not continuously)
        auto-revert-check-vc-info nil    ; Don't check VC info (expensive)
        auto-revert-verbose nil          ; Don't show messages
        auto-revert-use-notify t         ; Use file notifications when available
        auto-revert-avoid-polling t)     ; Prefer notifications over polling
  (global-auto-revert-mode 1)
  (require 'bind-key)
  (bind-key* "C-x k" #'kill-buffer-and-window)
  (bind-key* "C-x K" #'kill-buffer)
  (global-set-key (kbd "C-<tab>") 'next-buffer)
  (global-set-key (kbd "C-<iso-lefttab>") 'previous-buffer)

  (delete-selection-mode 1)
  (set-default 'truncate-lines t)

  (defun next-code-buffer ()
    (interactive)
    (let (( bread-crumb (buffer-name) ))
      (next-buffer)
      (while
          (and
           (string-match-p "^\*" (buffer-name))
           (not ( equal bread-crumb (buffer-name) )) )
        (next-buffer))))

  (defun previous-code-buffer ()
    (interactive)
    (let (( bread-crumb (buffer-name) ))
      (previous-buffer)
      (while
          (and
           (string-match-p "^\*" (buffer-name))
           (not ( equal bread-crumb (buffer-name) )) )
        (previous-buffer))))

  (global-set-key (kbd "C-M-o") 'next-code-buffer)
  (global-set-key (kbd "C-M-O") 'previous-code-buffer)

  (defun reverse-other-window ()
    (interactive)
    (other-window -1))

  (global-hl-line-mode 1)
#+END_SRC

** Bookmarks
This persists the bookmarks state after each bookmark modification.
It ensures that bookmarks are always up-to-date even when Emacs crashes.
As bookmarks are at the center of my workflow, this is a crucial option.

#+begin_src emacs-lisp
  (setq bookmark-save-flag 1)
#+end_src

** Indentation
#+BEGIN_SRC emacs-lisp
  (setq indent-tabs-mode nil
        indent-line-function 'insert-tab)
  (setq-default indent-tabs-mode nil)

  (defun tab/default-width (width)
    (interactive "nTab default width: ")

    (setq-default tab-width width)
    (setq c-basic-offset tab-width
          c-basic-offset tab-width
          c-basic-offset tab-width
          csharp-tree-sitter-indent-offset tab-width
          c-basic-offset tab-width
          c-basic-offset tab-width
          c-basic-offset tab-width
          js-indent-level tab-width
          js2-basic-offset tab-width
          js3-indent-level tab-width
          js-indent-level tab-width
          lua-indent-level tab-width
          c-basic-offset tab-width
          c-basic-offset tab-width
          perl-indent-level tab-width
          cperl-indent-level tab-width
          raku-indent-offset tab-width
          erlang-indent-level tab-width
          ada-indent tab-width
          sgml-basic-offset tab-width
          nxml-child-indent tab-width
          pascal-indent-level tab-width
          typescript-indent-level tab-width
          sh-basic-offset tab-width
          ruby-indent-level tab-width
          enh-ruby-indent-level tab-width
          crystal-indent-level tab-width
          css-indent-offset tab-width
          rust-indent-offset tab-width
          rustic-indent-offset tab-width
          scala-indent:step tab-width
          powershell-indent tab-width
          ess-indent-offset tab-width
          yaml-indent-offset tab-width
          hack-indent-offset tab-width
          standard-indent tab-width))

  (defun tab/width (width)
    (interactive "nTab width: ")
    (setq-local tab-width width
                c-basic-offset tab-width
                c-basic-offset tab-width
                c-basic-offset tab-width
                csharp-tree-sitter-indent-offset tab-width
                c-basic-offset tab-width
                c-basic-offset tab-width
                c-basic-offset tab-width
                js-indent-level tab-width
                js2-basic-offset tab-width
                js3-indent-level tab-width
                js-indent-level tab-width
                lua-indent-level tab-width
                c-basic-offset tab-width
                c-basic-offset tab-width
                perl-indent-level tab-width
                cperl-indent-level tab-width
                raku-indent-offset tab-width
                erlang-indent-level tab-width
                ada-indent tab-width
                sgml-basic-offset tab-width
                nxml-child-indent tab-width
                pascal-indent-level tab-width
                typescript-indent-level tab-width
                sh-basic-offset tab-width
                ruby-indent-level tab-width
                enh-ruby-indent-level tab-width
                crystal-indent-level tab-width
                css-indent-offset tab-width
                rust-indent-offset tab-width
                rustic-indent-offset tab-width
                scala-indent:step tab-width
                powershell-indent tab-width
                ess-indent-offset tab-width
                yaml-indent-offset tab-width
                hack-indent-offset tab-width
                standard-indent tab-width))

  (tab/default-width 4)
#+END_SRC

** Lines style
#+begin_src emacs-lisp
  (setq
   display-line-numbers-type 'relative
   mode-line-percent-position nil)
  (global-display-line-numbers-mode 1)
  (add-hook 'completion-list-mode-hook (lambda () (display-line-numbers-mode 0)))
  (line-number-mode 0)
  (column-number-mode 0)
  (global-hl-line-mode 0)
#+end_src

** Log level
#+BEGIN_SRC emacs-lisp
  (setq warning-minimum-level :error)
#+END_SRC

** Repeat
#+begin_src emacs-lisp
  (repeat-mode 1)
#+end_src

** Lighter interface
#+BEGIN_SRC emacs-lisp
  (scroll-bar-mode 1)
  (tool-bar-mode -1)
  (tooltip-mode -1)
  (menu-bar-mode -1)
  (cua-mode 1)
  (define-key isearch-mode-map (kbd "C-v") 'isearch-yank-kill)
  (setq window-divider-default-right-width 22
        window-divider-default-bottom-width 22)

  (window-divider-mode 1)

  (use-package spacious-padding
    :config
    (spacious-padding-mode 1))
#+END_SRC

** Fonts setting
#+BEGIN_SRC emacs-lisp
  (setq-default fill-column 148)

  (defun fonts/set-fonts ()
    (interactive)
    (set-face-attribute 'default nil :font "SauceCodePro NF-11")

    ;; Set the fixed pitch face
    (set-face-attribute 'fixed-pitch nil :font "SauceCodePro NF-11")

    ;; Set the variable pitch face
    (set-face-attribute 'variable-pitch nil :font "Cantarell-11" :weight 'regular)
    (dolist (face '(default fixed-pitch))
      (set-face-attribute `,face nil :font "SauceCodePro NF-11"))
    (fix-char-width-for-spinners))
  (add-hook 'server-after-make-frame-hook #'fonts/set-fonts)
#+END_SRC
| fonts/set-fonts | spacious-padding-set-parameters-of-selected-frame |

  (defun disable-mixed-pitch ()
    (interactive)
    (mixed-pitch-mode -1))

  (use-package mixed-pitch
    :hook
    ((org-mode . mixed-pitch-mode)
     (markdown-mode . mixed-pitch-mode)))

** Auth source encrypted
#+BEGIN_SRC emacs-lisp
  (setq auth-sources '("~/.authinfo.gpg"))
#+END_SRC
| ~/.authinfo.gpg |

** Tramp
#+BEGIN_SRC emacs-lisp
  (setq remote-file-name-inhibit-cache nil
        vc-ignore-dir-regexp
        (format "%s\\|%s"
                vc-ignore-dir-regexp
                tramp-file-name-regexp)
        tramp-verbose 1
        tramp-default-method "ssh"
        tramp-use-ssh-controlmaster-options nil
        tramp-chunksize 500
        tramp-auto-save-directory "~/.emacs.d/var/tramp-autosave/")

  (with-eval-after-load 'tramp
    (add-to-list 'tramp-remote-path 'tramp-own-remote-path))
#+END_SRC

* Dracula theme
#+BEGIN_SRC emacs-lisp
  (add-hook 'after-init-hook
            #'(lambda ()
                (load-file "~/.emacs.d/custom_packages/dracula-theme.el")
                (load-theme 'dracula t)

                (fringe-mode '(24 . 12))

                (defun theme/minibuffer-echo-area ()
                  (interactive)
                  (dolist (buf '( " *Minibuf-1*"))
                    (with-current-buffer (get-buffer-create buf)
                      (face-remap-add-relative 'default :background "#44475a")
                      (face-remap-add-relative 'fringe :background "#44475a")))
                  (dolist (buf '(" *Minibuf-0*" " *Echo Area 0*" " *Echo Area 1*"))
                    (with-current-buffer (get-buffer-create buf)
                      (when (= (buffer-size) 0)
                        (insert " "))
                      ;; Don't allow users to kill these buffers, as it destroys the hack
                      (add-hook 'kill-buffer-query-functions #'ignore nil 'local)
                      (set-window-scroll-bars (minibuffer-window) nil nil)
                      (face-remap-add-relative 'default :background "#282a36")
                      (face-remap-add-relative 'fringe :background "#282a36"))))))
#+END_SRC
| #[nil ((load-file ~/.emacs.d/custom_packages/dracula-theme.el) (load-theme 'dracula t) (fringe-mode '(24 . 12)) (defun theme/minibuffer-echo-area nil (interactive) (dolist (buf '( *Minibuf-1*)) (with-current-buffer (get-buffer-create buf) (face-remap-add-relative 'default :background #44475a) (face-remap-add-relative 'fringe :background #44475a))) (dolist (buf '( *Minibuf-0*  *Echo Area 0*  *Echo Area 1*)) (with-current-buffer (get-buffer-create buf) (when (= (buffer-size) 0) (insert  )) (add-hook 'kill-buffer-query-functions #'ignore nil 'local) (set-window-scroll-bars (minibuffer-window) nil nil) (face-remap-add-relative 'default :background #282a36) (face-remap-add-relative 'fringe :background #282a36))))) nil] | org-persist-load-all | #[nil ((let ((local-settings ~/.emacs.d/local.el)) (if (file-exists-p local-settings) (progn (load-file local-settings)))) (lsp)) nil] | doom-modeline-mode | #[nil ((load-file ~/.emacs.d/custom_packages/dracula-theme.el) (load-theme 'dracula t) (fringe-mode '(24 . 12)) (defalias 'theme/minibuffer-echo-area #'(lambda nil (interactive) (let ((tail '( *Minibuf-1*))) (while tail (let ((buf (car tail))) (save-current-buffer (set-buffer (get-buffer-create buf)) (face-remap-add-relative 'default :background #44475a) (face-remap-add-relative 'fringe :background #44475a)) (setq tail (cdr tail))))) (let ((tail '( *Minibuf-0*  *Echo Area 0*  *Echo Area 1*))) (while tail (let ((buf (car tail))) (save-current-buffer (set-buffer (get-buffer-create buf)) (if (= (buffer-size) 0) (progn (insert  ))) (add-hook 'kill-buffer-query-functions #'ignore nil 'local) (set-window-scroll-bars (minibuffer-window) nil nil) (face-remap-add-relative 'default :background #282a36) (face-remap-add-relative 'fringe :background #282a36)) (setq tail (cdr tail)))))))) nil] | pgtk-use-im-context-handler | tramp-register-archive-autoload-file-name-handler | magit-maybe-define-global-key-bindings | table--make-cell-map |

* Doom modeline
#+begin_src emacs-lisp
    (use-package doom-modeline
      :hook (after-init . doom-modeline-mode)
      :config
      (setq
       inhibit-compacting-font-caches t
       mode-line-right-align-edge 'window
       doom-modeline-percent-position nil
       doom-modeline-enable-word-count t
       doom-modeline-continuous-word-count-modes nil
       doom-modeline-total-line-number t
       doom-modeline-position-line-format '("" " " "%l")
       doom-modeline-position-column-line-format '("" " " "%cC %lL"))
      (line-number-mode 1)
      (column-number-mode 0))

    (use-package hide-mode-line
      :config
      (add-hook 'completion-list-mode-hook #'hide-mode-line-mode))

#+end_src

* Search & completion
** Built-in setup
#+begin_src emacs-lisp
  (setq tab-always-indent 'complete)
  (setq completions-format 'one-column
        completions-header-format nil
        completion-show-help nil
        completion-show-inline-help nil
        completions-max-height 30
        completion-auto-select nil)

  (setq-default isearch-lazy-count t
                isearch-allow-motion t)


  (defun my/minibuffer-choose-completion (&optional no-exit no-quit)
    (interactive "P")
    (with-minibuffer-completions-window
      (let ((completion-use-base-affixes nil))
        (choose-completion nil no-exit no-quit))))
#+END_SRC

** Helm
#+BEGIN_SRC emacs-lisp
  (use-package helm
    :config
    (setq helm-input-idle-delay                     0.1
          helm-reuse-last-window-split-state        nil
          helm-always-two-windows                   nil
          helm-split-window-default-side            'below
          helm-commands-using-frame                 '()
          helm-actions-inherit-frame-settings       t
          helm-use-frame-when-more-than-two-windows nil
          helm-use-frame-when-no-suitable-window    nil
          helm-persistent-action-display-window     t
          helm-show-action-window-other-window      'right
          helm-allow-mouse                          t
          helm-move-to-line-cycle-in-source         nil
          helm-echo-input-in-header-line            nil
          helm-autoresize-max-height                30   ; it is %.
          helm-autoresize-min-height                5   ; it is %.
          helm-follow-mode-persistent               t
          helm-candidate-number-limit               300
          helm-visible-mark-prefix                  "✓"
          helm-kill-real-or-display-selection       'real
          helm-truncate-lines                       t
          helm-net-prefer-curl                      t
          helm-split-window-inside-p                t
          helm-grep-git-grep-command "git --no-pager grep -n%cH --color=always --full-name -e %p"
          helm-buffers-show-icons nil
          helm-buffer-max-length 35)

    (defun helm--show-action-window-other-window-p ()
      helm-show-action-window-other-window)

    (defun helm/hook ()
      (display-line-numbers-mode 0))
    (add-hook 'helm-major-mode-hook 'helm/hook)

    (defun helm/grep-do-git-grep ()
      (interactive)
      (let* ((helm-candidate-number-limit nil))
        (call-interactively 'helm-grep-do-git-grep)))

    (defun helm/grep-do-git-grep-literal ()
      "Git grep with literal string matching (handles spaces and parentheses)."
      (interactive)
      (let* ((helm-candidate-number-limit nil)
             (pattern (read-string "Git grep literal: " (thing-at-point 'symbol)))
             (default-directory (or (helm-browse-project-get--root-dir (helm-current-directory))
                                    default-directory)))
        (helm-grep-git-1 default-directory nil nil (list "-F" "-e" pattern))))
    
    (defun helm/do-grep-ag ()
      (interactive)
      (let* ((helm-candidate-number-limit nil))
        (call-interactively 'helm-do-grep-ag)
        ))
    
    (defun helm/do-grep-ag-project ()
      (interactive)
      (let* ((helm-candidate-number-limit nil))
        (call-interactively 'helm-do-grep-ag-project)
        ))
    
    (defadvice helm-display-mode-line (after undisplay-header activate)
      (setq header-line-format nil))

    (global-set-key (kbd "C-h r")                        'helm-info-emacs)
    (global-set-key (kbd "M-x")                          'undefined)
    (global-set-key (kbd "M-x")                          'helm-M-x)
    (global-set-key (kbd "M-y")                          'helm-show-kill-ring)
    (global-set-key (kbd "C-x C-f")                      'helm-find-files)
    (global-set-key (kbd "C-x b")                        'helm-buffers-list)
    (global-set-key (kbd "C-c <SPC>")                    'helm-mark-ring)
    (global-set-key [remap bookmark-jump]                'helm-filtered-bookmarks)
    (global-set-key (kbd "C-c i")                        'helm-imenu)
    (global-set-key (kbd "C-c I")                        'helm-imenu-in-all-buffers)
    (global-set-key (kbd "C-:")                          'helm-eval-expression-with-eldoc)
    (global-set-key (kbd "C-,")                          'helm-calcul-expression)
    (global-set-key (kbd "C-h d")                        'helm-info-at-point)
    (global-set-key (kbd "C-h i")                        'helm-info)
    (global-set-key (kbd "C-x C-d")                      'helm-browse-project)
    (global-set-key (kbd "<f1>")                         'helm-resume)
    (global-set-key (kbd "C-h C-f")                      'helm-apropos)
    (global-set-key (kbd "C-h a")                        'helm-apropos)
    (global-set-key (kbd "C-h C-d")                      'helm-debug-open-last-log)
    (global-set-key (kbd "S-<f4>")                       'helm-execute-kmacro)
    (global-set-key (kbd "M-s")                          nil)
    (global-set-key (kbd "M-s M-s")                      'helm-occur-visible-buffers)
    (global-set-key (kbd "M-s M-d")                      'helm-find)
    (global-set-key (kbd "M-s M-o")                      'helm-org-agenda-files-headings)
    (global-set-key (kbd "M-s M-i")                      'helm-google-suggest)
    (global-set-key (kbd "C-x C-b")                      'helm-semantic-or-imenu)

    (define-key global-map (kbd "M-s M-g")               'helm/grep-do-git-grep)
    (define-key global-map (kbd "M-s M-G")               'helm/grep-do-git-grep-literal)
    (define-key global-map [remap bookmark-bmenu-list]   'helm-register)
    (define-key global-map [remap list-buffers]          'helm-buffers-list)
    (define-key global-map [remap dabbrev-expand]        'helm-dabbrev)
    (define-key global-map (kbd "M-g a")                 'helm/do-grep-ag)
    (define-key global-map (kbd "M-s M-p")               'helm/do-grep-ag-project)
    (define-key global-map (kbd "M-g l")                 'goto-line)
    (define-key global-map (kbd "M-g M-g")               'helm-revert-next-error-last-buffer)
    (define-key global-map (kbd "M-g i")                 'helm-gid)
    (define-key global-map (kbd "C-x r p")               'helm-projects-history)
    (define-key global-map (kbd "C-x r c")               'helm-addressbook-bookmarks)
    (define-key global-map (kbd "C-c t r")               'helm-dictionary)

    (helm-mode 1)
    (helm-autoresize-mode 1))

  (use-package helm-xref)

  (use-package helm-tramp)
#+END_SRC

** Company
#+BEGIN_SRC emacs-lisp
  (use-package company
    :defer 1  ; Delay loading by 1 second
    :bind
    (:map company-active-map
          ("<tab>" . company-complete-selection))
    (:map lsp-mode-map
          ("<tab>" . company-indent-or-complete-common))
    :custom
    (company-minimum-prefix-length 2)  ; Reduced CPU usage
    (company-idle-delay 0.15)          ; 0.01 was too aggressive
    (company-tooltip-idle-delay 0.15)
    :config
    (global-company-mode 1))
#+END_SRC

** Orderless
#+BEGIN_SRC emacs-lisp
  (use-package orderless
    :init
    (setq completion-styles '(orderless)
    completion-category-defaults nil
    completion-category-overrides '((file (styles partial-completion)))))
#+END_SRC

* Org mode
#+BEGIN_SRC emacs-lisp
  (use-package org
    :config
    (define-key org-mode-map (kbd "C-M-S-<left>") nil)
    (define-key org-mode-map (kbd "C-M-S-<right>") nil)
    (define-key org-mode-map (kbd "C-S-<right>") nil)
    (define-key org-mode-map (kbd "C-S-<left>") nil)

    (setq
     org-confirm-babel-evaluate nil
     org-image-actual-width t
     org-startup-with-inline-images t
     org-support-shift-select t)

    (load-file "~/.emacs.d/custom_packages/org-flyimage.el")
    (with-eval-after-load "org"
      (require 'org-flyimage)
      (add-hook 'org-mode-hook 'org-flyimage-mode))

    (defun org/org-babel-tangle-config ()
      (when (or (string-equal (buffer-file-name)
                              (expand-file-name "~/.dotfiles/README.org"))
                (string-equal (buffer-file-name)
                              (expand-file-name "~/.dotfiles/river/README.org"))
                (string-equal (buffer-file-name)
                              (expand-file-name "~/.dotfiles/fnott/README.org"))
                (string-equal (buffer-file-name)
                              (expand-file-name "~/.dotfiles/hyprland/README.org"))
                (string-equal (buffer-file-name)
                              (expand-file-name "~/.dotfiles/waybar/README.org"))
                (string-equal (buffer-file-name)
                              (expand-file-name "~/.dotfiles/emacs/README.org"))
                (string-equal (buffer-file-name)
                              (expand-file-name "~/.dotfiles/emacs/desktop.org"))
                (string-equal (buffer-file-name)
                              (expand-file-name "~/.dotfiles/emacs/local.org")))
        ;; Dynamic scoping to the rescue
        (let ((org-confirm-babel-evaluate nil))
          (org-babel-tangle))))
    (add-hook 'org-mode-hook (lambda () (add-hook 'after-save-hook #'org/org-babel-tangle-config)))
    (custom-set-faces
     '(org-level-1 ((t (:inherit outline-1 :height 2.5))))
     '(org-level-2 ((t (:inherit outline-2 :height 1.8))))
     '(org-level-3 ((t (:inherit outline-3 :height 1.4))))
     '(org-level-4 ((t (:inherit outline-4 :height 1.2))))
     '(org-level-5 ((t (:inherit outline-5 :height 1.0))))))
#+END_SRC

** Org roam
#+begin_src emacs-lisp
  ;; (make-directory "~/RoamNotes")
  (use-package org-roam
    :custom
    (org-roam-directory "~/RoamNotes")
    :bind (("C-c n l" . org-roam-buffer-toggle)
           ("C-c n f" . org-roam-node-find)
           ("C-c n i" . org-roam-node-insert))
    :config
    (org-roam-setup))

  (use-package org-roam-ui
    :vc (:url "https://github.com/org-roam/org-roam-ui" :rev :newest)
    :after org-roam
    ;;         normally we'd recommend hooking orui after org-roam, but since org-roam does not have
    ;;         a hookable mode anymore, you're advised to pick something yourself
    ;;         if you don't care about startup time, use
    ;;  :hook (after-init . org-roam-ui-mode)
    :config
    (setq org-roam-ui-sync-theme t
          org-roam-ui-follow t
          org-roam-ui-update-on-save t
          org-roam-ui-open-on-start t))

#+end_src

* Time package
#+BEGIN_SRC emacs-lisp
  (use-package time
    :ensure nil
    :commands world-clock
    :config
    (setq display-time-interval 60)
    (setq display-time-mail-directory nil)
    (setq display-time-default-load-average nil))
#+END_SRC

* Start desktop mode if needed
#+BEGIN_SRC emacs-lisp
  (autoload 'exwm-enable "~/.emacs.d/desktop.el")
#+END_SRC

* Movement packages
** Avy
#+BEGIN_SRC emacs-lisp
  (use-package avy
    :config
    (require 'bind-key)
    (bind-key "M-j" #'avy-goto-char-timer))
#+END_SRC

** Multiple cursors
#+BEGIN_SRC emacs-lisp
  (use-package multiple-cursors
    :vc (:url "https://github.com/magnars/multiple-cursors.el" :rev :newest)
    :hook
    ((multiple-cursors-mode . (lambda ()
                                (set-face-attribute 'mc/cursor-bar-face nil :height 1 :background nil :inherit 'cursor))))
    :config
    (global-set-key (kbd "C-S-c C-S-c") 'mc/edit-lines)
    (global-set-key (kbd "C-}") 'mc/mark-next-like-this)
    (global-set-key (kbd "C-{") 'mc/mark-previous-like-this)
    (global-set-key (kbd "C-;") 'mc/mark-all-like-this)
    (global-set-key (kbd "C-S-<mouse-1>") 'mc/add-cursor-on-click)
    (setq mc/black-list-prefer t))
#+END_SRC

** kmacro-x
#+BEGIN_SRC emacs-lisp
  (use-package kmacro-x
    :init (kmacro-x-atomic-undo-mode 1))
#+END_SRC

** Combobulate
#+begin_src emacs-lisp
  (use-package combobulate
    :vc (:url "https://github.com/mickeynp/combobulate" :rev :newest)
    :hook
    ((python-ts-mode . combobulate-mode)
     (js-ts-mode . combobulate-mode)
     (html-ts-mode . combobulate-mode)
     (css-ts-mode . combobulate-mode)
     (yaml-ts-mode . combobulate-mode)
     (typescript-ts-mode . combobulate-mode)
     (json-ts-mode . combobulate-mode)
     (tsx-ts-mode . combobulate-mode))
    :config
    (setq combobulate-flash-node nil))
#+end_src

** Goto last change
#+BEGIN_SRC emacs-lisp
  (use-package goto-last-change
    :config
    (global-set-key (kbd "C-z") 'goto-last-change))
#+END_SRC

** vundu
#+begin_src emacs-lisp
  (use-package vundo
    :vc (:url "https://github.com/casouri/vundo" :rev :newest)
    :bind (
           :map vundo-mode-map
           ("C-b" . vundo-backward)
           ("C-f" . vundo-forward)
           ("C-p" . vundo-previous)
           ("C-n" . vundo-next)
           ("<home>" . vundo-stem-root)
           ("<end>" . vundo-stem-end))
    :config
    (setq vundo-glyph-alist vundo-unicode-symbols)
    (global-unset-key (kbd "C-?"))
    (global-set-key (kbd "C-?") 'vundo))
#+end_src

* Advanced Appearance
** Hideshow
#+BEGIN_SRC emacs-lisp
  (use-package hideshow
    :ensure nil
    :hook
    (prog-mode . hs-minor-mode)
    (yaml-ts-mode . hs-minor-mode)
    :bind (
           :map prog-mode-map
           ("C-M-<tab>" . hs-cycle)
           ("C-M-<iso-lefttab>" . hs-global-cycle)
           :map hs-minor-mode-map
           ("C-M-<tab>" . hs-cycle)
           ("C-M-<iso-lefttab>" . hs-global-cycle))
    :config
    (defun hs-cycle (&optional level)
      (interactive "p")
      (let (message-log-max
            (inhibit-message t))
        (if (= level 1)
            (pcase last-command
              ('hs-cycle
               (hs-hide-level 1)
               (setq this-command 'hs-cycle-children))
              ('hs-cycle-children
               ;; TODO: Fix this case. `hs-show-block' needs to be
               ;; called twice to open all folds of the parent
               ;; block.
               (save-excursion (hs-show-block))
               (hs-show-block)
               (setq this-command 'hs-cycle-subtree))
              ('hs-cycle-subtree
               (hs-hide-block))
              (_
               (if (not (hs-already-hidden-p))
                   (hs-hide-block)
                 (hs-hide-level 1)
                 (setq this-command 'hs-cycle-children))))
          (hs-hide-level level)
          (setq this-command 'hs-hide-level))))

    (defun hs-global-cycle ()
      (interactive)
      (pcase last-command
        ('hs-global-cycle
         (save-excursion (hs-show-all))
         (setq this-command 'hs-global-show))
        (_ (hs-hide-all)))))
#+END_SRC

** All the icons
#+BEGIN_SRC emacs-lisp
  (use-package all-the-icons
    :if (display-graphic-p))

  (use-package all-the-icons-ibuffer
    :after all-the-icons)
#+END_SRC

** Coding style
#+BEGIN_SRC emacs-lisp
  (add-hook 'prog-mode-hook #'subword-mode)
  (defun custom/coding-faces ()
    (interactive)
    (set-face-attribute 'font-lock-keyword-face nil :weight 'ultra-bold)
    (set-face-attribute 'font-lock-comment-face nil :slant 'italic :weight 'normal)
    (set-face-attribute 'font-lock-function-name-face nil :slant 'italic :weight 'semi-bold)
    (set-face-attribute 'font-lock-string-face nil :weight 'normal :slant 'italic))

  (add-hook 'prog-mode-hook #'custom/coding-faces)
#+END_SRC

** Ediff style
#+BEGIN_SRC emacs-lisp
  (use-package ediff
      :ensure nil
      :config
      (setq ediff-window-setup-function 'ediff-setup-windows-plain
            ediff-split-window-function 'split-window-horizontally))
#+END_SRC

** Perfect margin
#+begin_src emacs-lisp
  (use-package perfect-margin
    :vc (:url "https://github.com/mpwang/perfect-margin" :rev :newest)
    :defer 2
    :bind (("C-c m" . perfect-margin-mode))
    :config
    (setq perfect-margin-only-set-left-margin nil
          perfect-margin-ignore-regexps '("*docker-container*" "*Ibuffer*" "* docker")
          perfect-margin-ignore-filters nil
          perfect-margin-visible-width 148
          perfect-margin-disable-in-splittable-check nil)

    (defun perfect-margin-minibuffer-setup ()
      "Apply perfect-margin to minibuffer window."
      (when perfect-margin-mode
        (let* ((win (active-minibuffer-window))
               (width (window-total-width win))
               (margin (max 0 (/ (- width perfect-margin-visible-width) 2))))
          (set-window-margins win margin margin))))
    (add-hook 'minibuffer-setup-hook #'perfect-margin-minibuffer-setup)

    (perfect-margin-mode 0))
#+end_src

* Utilities
** PGmacs
#+BEGIN_SRC emacs-lisp
  (use-package pgmacs
    :vc (:url "https://github.com/emarsden/pgmacs" :rev :newest)
    :defer t)
#+END_SRC

** string-inflection
#+BEGIN_SRC emacs-lisp
  (use-package string-inflection
    :defer t
    :bind (("C-c C-u C-u" . string-inflection-upcase)
           ("C-c C-u C-k" . string-inflection-kebab-case)
           ("C-c C-u C-c" . string-inflection-lower-camelcase)
           ("C-c C-u C-S-c" . string-inflection-camelcase)
           ("C-c C-u C--" . string-inflection-underscore)
           ("C-c C-u C-_" . string-inflection-capital-underscore)))
#+END_SRC

** Sudo edit
#+BEGIN_SRC emacs-lisp
  (use-package sudo-edit
    :commands (sudo-edit sudo-edit-find-file))
#+END_SRC

** which-key
#+BEGIN_SRC emacs-lisp
  (use-package which-key
    :defer 2  ; Load after 2 seconds idle
    :config
    (setq which-key-popup-type 'minibuffer
          which-key-idle-delay 0.5)  ; Show after 0.5s
    (which-key-mode 1))
#+END_SRC

** Whole line or region
#+begin_src emacs-lisp
  (use-package whole-line-or-region
    :defer 1
    :config
    (whole-line-or-region-global-mode 1))
#+end_src

** Ibuffer
#+begin_src emacs-lisp
  (use-package ibuffer-vc
    :config
    (setq ibuffer-formats
          '((mark modified read-only " "
                  (name 80 80 :left :elide) ; change: 30s were originally 18s
                  " "
                  (size 9 -1 :right)
                  " "
                  (mode 16 16 :left :elide)
                  " " filename-and-process)
            (mark " "
                  (name 16 -1)
                  " " filename)))

    (defun ibuffer/apply-filter-groups ()
      "Combine my saved ibuffer filter groups with those generated
     by `ibuffer-vc-generate-filter-groups-by-vc-root'"
      (interactive)
      (setq ibuffer-filter-groups
            (append
             (ibuffer-vc-generate-filter-groups-by-vc-root)
             ibuffer-saved-filter-groups))

      (let ((ibuf (get-buffer "*Ibuffer*")))
        (when ibuf
          (with-current-buffer ibuf
            (pop-to-buffer ibuf)
            (ibuffer-update nil t)))))

    (add-hook 'ibuffer-hook 'ibuffer/apply-filter-groups)
    (add-hook 'ibuffer-hook 'ibuffer-auto-mode))
  (global-set-key (kbd "C-x C-b") 'ibuffer)
#+end_src

** blist
#+BEGIN_SRC emacs-lisp
  (use-package blist
    :vc (:url "https://github.com/emacs-straight/blist" :rev :newest)
    :config
    (setq blist-filter-groups
          (list
           (cons "Chrome" #'blist-chrome-p)
           (cons "Eshell" #'blist-eshell-p)
           (cons "PDF" #'blist-pdf-p)
           (cons "Info" #'blist-info-p)
           (cons "Default" #'blist-default-p)))

    (blist-define-criterion "pdf" "PDF"
                            (eq (bookmark-get-handler bookmark)
                                #'pdf-view-bookmark-jump))

    (blist-define-criterion "info" "Info"
                            (eq (bookmark-get-handler bookmark)
                                #'Info-bookmark-jump))

    (blist-define-criterion "elisp" "ELisp"
                            (string-match-p
                             "\\.el$"
                             (bookmark-get-filename bookmark)))

    (blist-define-criterion "chrome" "Chrome"
                            (eq (bookmark-get-handler bookmark)
                                #'bookmark/chrome-bookmark-handler)))
#+END_SRC

** Wgrep
#+BEGIN_SRC emacs-lisp
  (use-package wgrep
    :defer t
    :config
    (setq wgrep-auto-save-buffer t)

    (defun wgrep/hook ()
      (wgrep-change-to-wgrep-mode))

    (add-hook 'helm-occur-mode-hook 'wgrep/hook)
    (add-hook 'helm-grep-mode-hook 'wgrep/hook))

  (use-package wgrep-helm
    :after (wgrep helm))
#+END_SRC

** Savehist
#+BEGIN_SRC emacs-lisp
  (use-package savehist
    :ensure nil
    :init
    (savehist-mode))
#+END_SRC

** Helpful
#+BEGIN_SRC emacs-lisp
  (use-package helpful
    :defer t
    :bind (("C-h f" . helpful-callable)
           ("C-h v" . helpful-variable)
           ("C-h k" . helpful-key)
           ("C-c C-d" . helpful-at-point)
           ("C-h F" . helpful-function)
           ("C-h C" . helpful-command))
    :config
    (setq counsel-describe-function-function #'helpful-callable)
    (setq counsel-describe-variable-funtion #'helpful-variable))
#+END_SRC

** Explain pause mode
#+BEGIN_SRC emacs-lisp
  (use-package explain-pause-mode
    :vc (:url "https://github.com/lastquestion/explain-pause-mode" :rev :newest))
#+END_SRC

** Free keys
#+BEGIN_SRC emacs-lisp
  (use-package free-keys
    :commands free-keys)
#+END_SRC

** Csv mode
#+begin_src emacs-lisp
  (use-package csv-mode
    :vc (:url "https://github.com/emacsmirror/csv-mode" :rev :newest)
    :config
    (setq csv-comment-start-default nil)
    (customize-set-variable 'csv-separators '("," "	" ";" "~"))
    (customize-set-variable 'csv-header-lines 1)
    (add-hook 'csv-mode-hook 'csv-align-mode)
    (add-hook 'csv-mode-hook 'csv-header-line)

    (defcustom csv+-quoted-newline "\^@"
      "Replace for newlines in quoted fields."
      :group 'sv
      :type 'string)

    (defun csv+-quoted-newlines (&optional b e inv)
      "Replace newlines in quoted fields of region B E by `csv+-quoted-newline'.
  B and E default to `point-min' and `point-max', respectively.
  If INV is non-nil replace quoted `csv+-quoted-newline' chars by newlines."
      (interactive
       (append (when (region-active-p)
                 (list (region-begin)
                       (region-end)))
               prefix-arg))
      (unless b (setq b (point-min)))
      (unless e (setq e (point-max)))
      (save-excursion
        (goto-char b)
        (let ((from (if inv csv+-quoted-newline "\n"))
              (to (if inv "\n" csv+-quoted-newline)))
          (while (search-forward from e t)
            (when (nth 3 (save-excursion (syntax-ppss (1- (point)))))
              (replace-match to))))))

    (defsubst csv+-quoted-newlines-write-contents ()
      "Inverse operation of `csv+-quoted-newlines' for the full buffer."
      (save-excursion
        (save-restriction
          (widen)
          (let ((file (buffer-file-name))
                (contents (buffer-string)))
            (with-temp-buffer
              (insert contents)
              (csv+-quoted-newlines (point-min) (point-max) t)
              (write-region (point-min) (point-max) file)))))
      (set-visited-file-modtime)
      (set-buffer-modified-p nil)
      t ;; File contents has been written (see `write-contents-functions').
      )

    (defun csv+-setup-quoted-newlines ()
      "Hook function for `csv-mode-hook'.
  Transform newlines in quoted fields to `csv+-quoted-newlines'
  when reading files and the other way around when writing contents."
      (add-hook 'write-contents-functions #'csv+-quoted-newlines-write-contents t t)
      (let ((modified-p (buffer-modified-p)))
        (csv+-quoted-newlines)
        (set-buffer-modified-p modified-p)))

    (remove-hook 'csv-mode-hook #'csv+-setup-quoted-newlines))
#+end_src

** d2 mode
#+begin_src emacs-lisp
  (use-package d2-mode)

  (use-package ob-d2
    :vc (:url "https://github.com/dmacvicar/ob-d2" :rev :newest)
    :defer t)
#+end_src

** Jinx
#+begin_src emacs-lisp
  (use-package jinx
    :ensure nil
    :hook (emacs-startup . global-jinx-mode)
    :bind (("M-$" . jinx-correct)
           ("C-M-$" . jinx-languages)))
#+end_src

** Docker
#+begin_src emacs-lisp
  (use-package docker
    :config
    (global-set-key (kbd "C-c d") 'docker)
    (setq docker-show-messages nil
          docker-container-default-sort-key '("Names")
          docker-pop-to-buffer-action '((display-buffer-pop-up-frame)))

    (defun docker-run-async-with-buffer-shell (program &rest args)
      "Execute \"PROGRAM ARGS\" and display output in a new `shell' buffer."
      (let* ((process (apply #'docker-run-start-file-process-shell-command program args))
             (buffer (process-buffer process)))
        (set-process-query-on-exit-flag process nil)
        (with-current-buffer buffer (shell-mode))
        (set-process-filter process 'comint-output-filter)
        (display-buffer-same-window buffer nil)))

    (defun docker-run-async-with-buffer-vterm (program &rest args)
      "Execute \"PROGRAM ARGS\" and display output in a new `vterm' buffer."
      (defvar vterm-kill-buffer-on-exit)
      (defvar vterm-shell)
      (if (fboundp 'vterm-same-window)
          (let* ((process-args (-remove 's-blank? (-flatten args)))
                 (vterm-shell (s-join " " (-insert-at 0 program process-args)))
                 (vterm-kill-buffer-on-exit nil))
            (vterm-same-window
             (apply #'docker-utils-generate-new-buffer-name program process-args)))
        (error "The vterm package is not installed")))
    
    (defun docker-run-async-with-buffer-shell (program &rest args)
      "Execute \"PROGRAM ARGS\" and display output in a new `shell' buffer."
      (let* ((process (apply #'docker-run-start-file-process-shell-command program args))
             (buffer (process-buffer process)))
        (set-process-query-on-exit-flag process nil)
        (with-current-buffer buffer (shell-mode))
        (set-process-filter process 'comint-output-filter)
        (display-buffer-same-window buffer nil)))
    
    (defun run-with-local-timer (secs repeat function &rest args)
      "Like `run-with-idle-timer', but always runs in the `current-buffer'.

    Cancels itself, if this buffer was killed."
      (let* (;; Chicken and egg problem.
             (fns (make-symbol "local-timer"))
             (timer (apply 'run-with-timer secs repeat fns args))
             (fn `(lambda (&rest args)
                    (if (not (buffer-live-p ,(current-buffer)))
                        (cancel-timer ,timer)
                      (with-current-buffer ,(current-buffer)
                        (apply (function ,function) args))))))
        (fset fns fn)
        fn))

    (defun docker/auto-refresh ()
      "Auto-refresh docker containers view. Cancels itself, if this buffer was killed."
      (run-with-local-timer 5 5 'revert-buffer))

    (add-hook 'docker-container-mode-hook #'docker/auto-refresh)

    (docker-utils-columns-setter 'docker-container-columns '((:name "Names" :width 40 :template "{{ json .Names }}" :sort nil :format nil)
                                                             (:name "Status" :width 40 :template "{{ json .Status }}" :sort nil :format nil)
                                                             (:name "Ports" :width 60 :template "{{ json .Ports }}" :sort nil :format nil)
                                                             (:name "Id" :width 16 :template "{{ json .ID }}" :sort nil :format nil)
                                                             (:name "Image" :width 90 :template "{{ json .Image }}" :sort nil :format nil)
                                                             (:name "Command" :width 30 :template "{{ json .Command }}" :sort nil :format nil)
                                                             (:name "Created" :width 23 :template "{{ json .CreatedAt }}" :sort nil :format
                                                                    (lambda (x) (format-time-string "%F %T" (date-to-time x))))
                                                             )
                                 )
    )
#+end_src

** gptel
#+BEGIN_SRC emacs-lisp
  (use-package gptel
    :config
    (setq
     gptel-default-mode 'org-mode
     gptel-prompt-prefix-alist '((markdown-mode . "## ") (org-mode . "** ") (text-mode . "## "))
     gptel-display-buffer-action '((display-buffer-pop-up-frame))))
#+END_SRC

** Claude
#+BEGIN_SRC emacs-lisp
  (use-package claudemacs
    :vc (:url "https://github.com/cpoile/claudemacs"
              :rev :newest
              :branch "main")
    :config
    (setq claudemacs-use-shell-env t
          claudemacs-switch-to-buffer-on-create nil
          claudemacs-switch-to-buffer-on-toggle nil
          claudemacs-switch-to-buffer-on-file-add nil
          claudemacs-switch-to-buffer-on-send-error nil
          claudemacs-switch-to-buffer-on-add-context nil)

    (add-to-list 'display-buffer-alist
                 '("^\\*claudemacs"
                   (display-buffer-reuse-window display-buffer-pop-up-frame)
                   (reusable-frames . visible)))

    (defvar claudemacs--scroll-timer nil)

    (defun claudemacs/scroll-to-bottom ()
      "Scroll all claudemacs windows to the bottom."
      (dolist (buf (buffer-list))
        (when (and (buffer-live-p buf)
                   (string-prefix-p "*claudemacs" (buffer-name buf)))
          (dolist (window (get-buffer-window-list buf nil t))
            (with-selected-window window
              (goto-char (point-max))
              (recenter -1))))))

    (defun claudemacs/start-scroll-timer ()
      "Start auto-scroll timer for claudemacs."
      (unless claudemacs--scroll-timer
        (setq claudemacs--scroll-timer
              (run-with-timer 0 0.5 #'claudemacs/scroll-to-bottom))))

    (defun claudemacs/stop-scroll-timer ()
      "Stop auto-scroll timer."
      (when claudemacs--scroll-timer
        (cancel-timer claudemacs--scroll-timer)
        (setq claudemacs--scroll-timer nil)))

    (defun claudemacs/toggle-follow ()
      "Toggle auto-scroll for claudemacs buffers."
      (interactive)
      (if claudemacs--scroll-timer
          (progn
            (claudemacs/stop-scroll-timer)
            (message "Claudemacs follow: OFF"))
        (claudemacs/start-scroll-timer)
        (message "Claudemacs follow: ON")))

    (transient-append-suffix 'claudemacs-transient-menu '(-1)
      ["Quick"
       ("c" "Claude" transient:claudemacs-start-menu::0)
       ("f" "Toggle follow" claudemacs/toggle-follow)])

    (defun claudemacs/startup-hook ()
      (claudemacs/start-scroll-timer)
      (run-with-timer 0.5 nil #'eat-emacs-mode))

    (add-hook 'claudemacs-startup-hook #'claudemacs/startup-hook)

    (global-set-key (kbd "C-c c") #'claudemacs-transient-menu))
#+END_SRC

** structured logs
#+BEGIN_SRC emacs-lisp
   (load-file "~/.emacs.d/custom_packages/structured-log-mode.el")
#+END_SRC

* Coding
** Nix
#+BEGIN_SRC emacs-lisp
  (use-package nix-mode
    :mode "\\.nix\\'")
#+END_SRC

** Electric pair
#+BEGIN_SRC emacs-lisp
  (setq electric-pair-pairs
    '(
      (?\' . ?\')
      (?\" . ?\")
      (?\[ . ?\])
      (?\{ . ?\})))

  (defun electric-pair/activate ()
    (interactive)
    (electric-pair-mode 1))

  (defun electric-pair/deactivate ()
    (interactive)
    (electric-pair-mode -1))

  (add-hook 'activate-mark-hook #'electric-pair/activate)
  (add-hook 'deactivate-mark-hook #'electric-pair/deactivate)
#+END_SRC

** Electric indent
#+begin_src emacs-lisp
  (electric-indent-mode 1)
  (defun electric-indent/inhibit ()
    (interactive)
    (setq-local electric-indent-inhibit t))
#+end_src
 
** The only holy git client !
#+BEGIN_SRC emacs-lisp
  (use-package ilist
    :vc (:url "https://github.com/emacs-straight/ilist" :rev :newest)
    :defer t)

  (use-package transient
    :defer t)

  (use-package magit
    :defer t
    :commands (magit-status magit-clone magit-blame)
    :bind (("C-x g g" . magit-status)
           ("C-x g c" . magit-clone)
           ("C-x g s" . magit/magit-status-no-split))
    :config
    (require 'ilist)
    (defun magit/magit-status-no-split ()
      "Don't split window."
      (interactive)
      (let ((magit-display-buffer-function 'magit-display-buffer-same-window-except-diff-v1))
        (magit-status)))
    (setq magit-bury-buffer-function 'magit-mode-quit-window))

  (use-package magit-todos
    :after magit
    :config (magit-todos-mode 1))

  (use-package forge
    :after magit
    :config
    (global-set-key (kbd "M-o") #'forge-browse)
    (defun forge--format-topic-title (topic)
      (with-temp-buffer
        (save-excursion
          (with-slots (title status state) topic
            (insert
             (magit--propertize-face
              title
              `(,@(and (forge-pullreq-p topic)
                       (oref topic draft-p)
                       '(forge-pullreq-draft))
                ,(pcase status
                   ('unread  'forge-topic-unread)
                   ('pending 'forge-topic-pending)
                   ('done    'forge-topic-done))
                ,(pcase (list (eieio-object-class topic) state)
                   (`(forge-issue   open)      'forge-issue-open)
                   (`(forge-issue   completed) 'forge-issue-completed)
                   (`(forge-issue   unplanned) 'forge-issue-unplanned)
                   (`(forge-pullreq open)      'forge-pullreq-open)
                   (`(forge-pullreq merged)    'forge-pullreq-merged)
                   (`(forge-pullreq rejected)  'forge-pullreq-rejected)))))))
        (run-hook-wrapped 'forge-topic-wash-title-hook
                          (lambda (fn) (prog1 nil (save-excursion (funcall fn)))))
        (buffer-string)))
    )
#+END_SRC

** Yasnippet
#+BEGIN_SRC emacs-lisp
  (use-package yasnippet
    :defer 2
    :config
    (setq yas-inhibit-overlay-modification-protection nil)
    (yas-global-mode 1))

  (with-eval-after-load 'company
    (with-eval-after-load 'yasnippet
      (defun my/yas-company-complete-selection (fn)
        "Let company complete without breaking yasnippet fields."
        (if (and (bound-and-true-p yas-minor-mode)
                 (let ((field (condition-case nil (yas-current-field) (error nil))))
                   field))
            (let ((inhibit-modification-hooks t))
              (funcall fn))
          (funcall fn)))
      (advice-add 'company-complete-selection :around #'my/yas-company-complete-selection)))

  (use-package yasnippet-snippets
    :after yasnippet)
#+END_SRC

** Json Web Token
#+begin_src emacs-lisp
  (use-package jwt
    :vc (:url "https://github.com/joshbax189/jwt-el" :rev :newest))
#+end_src

** NodeJS REPL
#+begin_src emacs-lisp
  (use-package nodejs-repl
    :config
    (defun nodejs-repl/remove-broken-filter ()
      (remove-hook 'comint-output-filter-functions 'nodejs-repl--delete-prompt t))
    (add-hook 'nodejs-repl-mode-hook #'nodejs-repl/remove-broken-filter))
#+end_src

** TypeScript
#+begin_src emacs-lisp
  (use-package typescript-mode
    :mode "\\.ts\\'")
#+end_src

** Vue
#+BEGIN_SRC emacs-lisp
  (use-package vue-mode
    :mode "\\.vue\\'")
#+END_SRC

** PHP
#+begin_src emacs-lisp
  (use-package php-mode)
#+end_src

** SQL
#+begin_src emacs-lisp
  (use-package sqlup-mode
    :config
    (add-hook 'sql-mode-hook 'sqlup-mode))
#+end_src

** SQLite
#+begin_src emacs-lisp
  (use-package sqlite-mode-extras
    :vc (:url "https://github.com/xenodium/sqlite-mode-extras" :rev :newest)
    :hook ((sqlite-mode . sqlite-extras-minor-mode)))
#+end_src

** Jest
#+begin_src emacs-lisp
  (use-package jest-test-mode
    :commands jest-test-mode
    :hook (typescript-mode typescript-ts-mode js-mode js-ts-mode typescript-tsx-mode)
    :config
    (add-to-list
     'display-buffer-alist
     '("\\*jest-test-compilation\\*"
       (display-buffer-reuse-window display-buffer-pop-up-frame)
       (reusable-frames . visible))))
#+end_src

** Apheleia
#+BEGIN_SRC emacs-lisp
  (use-package apheleia
    :config
    (push
     '(eslint
       . ("apheleia-npx" "eslint_d" "--fix-to-stdout" "--stdin" "--stdin-filename" file)) apheleia-formatters)
    (add-to-list 'apheleia-mode-alist '(js-mode . eslint))
    (add-to-list 'apheleia-mode-alist '(js-ts-mode . eslint))
    (add-to-list 'apheleia-mode-alist '(typescript-mode . eslint))
    (add-to-list 'apheleia-mode-alist '(typescript-ts-mode . eslint))
    (apheleia-global-mode t))
#+END_SRC

** Tree-sitter
#+BEGIN_SRC emacs-lisp
  (use-package treesit-auto
    :custom
    (treesit-auto-install 'prompt)
    :config
    (treesit-auto-add-to-auto-mode-alist 'all)
    (global-treesit-auto-mode))
#+END_SRC

** Flycheck
#+BEGIN_SRC emacs-lisp
  (use-package flycheck
    :defer 2
    :config
    (setq flycheck-idle-change-delay 1.0  ; Wait before checking
          flycheck-display-errors-delay 0.5)
    (global-flycheck-mode 1))

  (use-package flycheck-title
    :after flycheck
    :config
    (flycheck-title-mode))
#+END_SRC

** lsp-mode
#+BEGIN_SRC emacs-lisp
  (setenv "LSP_USE_PLISTS" "true")

  (use-package lsp-mode
    :init
    ;; set prefix for lsp-command-keymap (few alternatives - "C-l", "C-c l")
    (setq lsp-keymap-prefix "C-c l")
    :hook (;; replace XXX-mode with concrete major-mode(e. g. python-mode)
           ((js-mode js-ts-mode typescript-ts-mode typescript-mode php-mode vue-mode) . lsp-deferred)
           ;; if you want which-key integration
           (lsp-mode . lsp-enable-which-key-integration))
    :config
    (setq lsp-headerline-breadcrumb-enable nil
          lsp-completion-provider :none
          lsp-log-io nil
          lsp-idle-delay 0.5
          lsp-enable-file-watchers t
          lsp-enable-folding nil
          lsp-enable-symbol-highlighting t
          lsp-enable-on-type-formatting nil)

    (defun add-yasnippet-enable-company ()
      (setq-local company-backends '((:separate company-yasnippet company-capf)))
      (company-mode 1))
    (add-hook 'lsp-mode-hook #'add-yasnippet-enable-company)

    (defun lsp-booster--advice-json-parse (old-fn &rest args)
      "Try to parse bytecode instead of json."
      (or
       (when (equal (following-char) ?#)
         (let ((bytecode (read (current-buffer))))
           (when (byte-code-function-p bytecode)
             (funcall bytecode))))
       (apply old-fn args)))
    (advice-add (if (progn (require 'json)
                           (fboundp 'json-parse-buffer))
                    'json-parse-buffer
                  'json-read)
                :around
                #'lsp-booster--advice-json-parse)

    (defun lsp-booster--advice-final-command (old-fn cmd &optional test?)
      "Prepend emacs-lsp-booster command to lsp CMD."
      (let ((orig-result (funcall old-fn cmd test?)))
        (if (and (not test?)                             ;; for check lsp-server-present?
                 (not (file-remote-p default-directory)) ;; see lsp-resolve-final-command, it would add extra shell wrapper
                 lsp-use-plists
                 (not (functionp 'json-rpc-connection))  ;; native json-rpc
                 (executable-find "emacs-lsp-booster"))
            (progn
              (when-let ((command-from-exec-path (executable-find (car orig-result))))  ;; resolve command from exec-path (in case not found in $PATH)
                (setcar orig-result command-from-exec-path))
              (message "Using emacs-lsp-booster for %s!" orig-result)
              (cons "emacs-lsp-booster" orig-result))
          orig-result)))
    (advice-add 'lsp-resolve-final-command :around #'lsp-booster--advice-final-command))

  ;; (use-package lsp-ui :commands lsp-ui-mode)
  (use-package helm-lsp :commands helm-lsp-workspace-symbol)

  (use-package dap-mode
    :defer t
    :commands (dap-debug dap-debug-edit-template))
#+END_SRC

** Expand Region
#+BEGIN_SRC emacs-lisp
  (use-package expreg
    :vc (:url "https://github.com/casouri/expreg" :rev :newest)
    :defer t
    :bind (("C-=" . expreg-expand)
           ("C-`" . expreg-contract)))
#+END_SRC

* Shells & terminals
** exec-path-from-shell
#+begin_src emacs-lisp
  (use-package exec-path-from-shell
    :config
    (when (memq window-system '(mac ns x))
      (exec-path-from-shell-initialize)))
  
  (defun shell/hook ()
    (display-line-numbers-mode 0)
    (visual-line-mode 1))
  (add-hook 'shell-mode-hook #'shell/hook)
#+end_src

** Eshell
#+begin_src emacs-lisp
  (defun utils/get-project-root-if-wanted ()
    (interactive)
    (let ((cur-buffer (window-buffer (selected-window))))
      (with-current-buffer cur-buffer
        (or (and (fboundp 'project-current)
                 (project-current)
                 (project-root (project-current)))
            (vc-root-dir)
            (when (derived-mode-p 'dired-mode)
              (replace-regexp-in-string "^[Directory ]*" "" (pwd)))
            default-directory))))

  (custom-set-faces
   `(ansi-color-black ((t (:foreground "#282a36"))))
   `(ansi-color-red ((t (:foreground "#ff5555"))))
   `(ansi-color-green ((t (:foreground "#50fa7b"))))
   `(ansi-color-yellow ((t (:foreground "#f1fa8c"))))
   `(ansi-color-blue ((t (:foreground "#bd93f9"))))
   `(ansi-color-magenta ((t (:foreground "#ff79c6"))))
   `(ansi-color-cyan ((t (:foreground "#8be9fd"))))
   `(ansi-color-gray ((t (:foreground "#f8f8f2")))))

  (setq eshell-banner-message "")

  (defun eshell/hook ()
    (require 'eshell)
    (require 'em-smart)
    (define-key eshell-mode-map (kbd "M-m") #'eshell-bol)
    (define-key eshell-hist-mode-map (kbd "M-s") nil)
    (define-key eshell-hist-mode-map (kbd "M-r") #'helm-eshell-history)
    (setq 
     eshell-where-to-jump 'begin
     eshell-review-quick-commands nil
     eshell-smart-space-goes-to-end t
     eshell-prompt-function
     (lambda ()
       (concat (format-time-string " %Y-%m-%d %H:%M" (current-time))
               (if (= (user-uid) 0) " # " " $ ")))
     eshell-highlight-prompt t)
    (set-face-attribute 'eshell-prompt nil :weight 'ultra-bold :inherit 'minibuffer-prompt)
    (eat-eshell-mode 1)
    (eat-eshell-visual-command-mode 1)
    (display-line-numbers-mode 0)
    ;; Disable automatic company completion, only complete on Tab
    (setq-local company-idle-delay nil)
    (define-key eshell-mode-map (kbd "<tab>") #'company-complete))
  (add-hook 'eshell-mode-hook #'eshell/hook)

  (defun eshell/rename-with-current-path ()
    (interactive)
    (rename-buffer (concat "Eshell: " (replace-regexp-in-string "^[Directory ]*" "" (pwd))) t))
  (add-hook 'eshell-directory-change-hook #'eshell/rename-with-current-path)
  (add-hook 'eshell-mode-hook #'eshell/rename-with-current-path)

  (defun eshell/get-relevant-buffer (path)
    (message path)
    (get-buffer (concat "Eshell: " (replace-regexp-in-string "/$" "" path))))

  (defun eshell/new-or-current ()
    "Open a new instance of eshell.
If in a dired buffer, open eshell in the current directory.
Otherwise, open in the project root.
Reuses an existing eshell buffer for the target directory if one exists."
    (interactive)
    (let* ((default-directory (replace-regexp-in-string "/$" ""
                                (if (derived-mode-p 'dired-mode)
                                    default-directory
                                  (utils/get-project-root-if-wanted))))
           (eshell-buffer (eshell/get-relevant-buffer default-directory)))
      (if eshell-buffer
          (switch-to-buffer eshell-buffer)
        (eshell 'N))))

  (global-set-key (kbd "C-s-<return>") #'eshell/new-or-current)

  (use-package eshell
    :ensure nil)
#+end_src

*** Eat
#+begin_src emacs-lisp
  (use-package eat
    :vc (:url "https://codeberg.org/akib/emacs-eat" :rev :newest)
    :config
    (setq eshell-visual-commands '()
          eat-enable-blinking-text nil)

    (defun fix-char-width-for-spinners ()
      "Fix character width for common spinner/animation characters."
      (setq use-default-font-for-symbols nil)

      (set-fontset-font t 'symbol "DejaVu Sans Mono" nil 'prepend)

      (set-fontset-font t 'emoji "DejaVuSans" nil 'prepend)

      (set-fontset-font t '(#x2800 . #x28FF) "DejaVu Sans Mono")
      (set-fontset-font t '(#x2500 . #x257F) "DejaVu Sans Mono")
      (set-fontset-font t '(#x2580 . #x259F) "DejaVu Sans Mono")
      (set-fontset-font t '(#x2190 . #x21FF) "DejaVu Sans Mono")
      (set-fontset-font t '(#x2700 . #x27BF) "DejaVu Sans Mono")
      (set-fontset-font t #x00B7 "DejaVu Sans Mono")

      (set-char-table-range char-width-table '(#x2800 . #x28FF) 1)  ;; Braille
      (set-char-table-range char-width-table '(#x2500 . #x257F) 1)  ;; Box drawing
      (set-char-table-range char-width-table '(#x2580 . #x259F) 1)  ;; Block elements
      (set-char-table-range char-width-table '(#x25A0 . #x25FF) 1)  ;; Geometric shapes
      (set-char-table-range char-width-table '(#x2190 . #x21FF) 1)  ;; Arrows
      (set-char-table-range char-width-table '(#x2700 . #x27BF) 1)  ;; Dingbats (✢ ✶ ✻ ✽)
      (set-char-table-range char-width-table #x00B7 1))             ;; Middle dot (· ✢ ✶ ✻ ✽)

    ;; (eat-exec buffer name "bash" nil (list "-ilc" command))
    (defun start-file-process-shell-command-using-eat-exec
        (name buffer command)
      (require 'eat)
      (with-current-buffer (eat-exec buffer name "nu" nil (list "-c" command))
        (eat-emacs-mode)
        (setq eat--synchronize-scroll-function #'eat--synchronize-scroll)
        (get-buffer-process (current-buffer))))

    (advice-add #'compilation-start :around
                (defun hijack-start-file-process-shell-command (o &rest args)
                  (advice-add #'start-file-process-shell-command :override
                              #'start-file-process-shell-command-using-eat-exec)
                  (unwind-protect
                      (apply o args)
                    (advice-remove
                     #'start-file-process-shell-command
                     #'start-file-process-shell-command-using-eat-exec))))

    (add-hook #'compilation-start-hook
              (defun revert-to-eat-setup (proc)
                (set-process-filter proc #'eat--filter)
                (add-function :after (process-sentinel proc) #'eat--sentinel)))

    (advice-add #'kill-compilation :override
                (defun kill-compilation-by-sending-C-c ()
                  (interactive)
                  (let ((buffer (compilation-find-buffer)))
                    (if (get-buffer-process buffer)
    	                  ;; interrupt-process does not work
                        (process-send-string (get-buffer-process buffer) (kbd "C-c"))
                      (error "The %s process is not running" (downcase mode-name))))))

    (add-hook 'eat-mode-hook #'shell/hook)
    ;; Auto-scroll eat buffers even when window doesn't have focus
    (add-hook 'eat-mode-hook
              (lambda ()
                (setq-local eat--synchronize-scroll-function #'eat--synchronize-scroll)))
    (with-eval-after-load 'eat
      ;; Couleurs standard (0-7)                                                                                                                        
      (set-face-foreground 'eat-term-color-0 "#282a36")  ; black                                                                                        
      (set-face-foreground 'eat-term-color-1 "#ff5555")  ; red                                                                                          
      (set-face-foreground 'eat-term-color-2 "#50fa7b")  ; green                                                                                        
      (set-face-foreground 'eat-term-color-3 "#f1fa8c")  ; yellow                                                                                       
      (set-face-foreground 'eat-term-color-4 "#bd93f9")  ; blue                                                                                         
      (set-face-foreground 'eat-term-color-5 "#ff79c6")  ; magenta                                                                                      
      (set-face-foreground 'eat-term-color-6 "#8be9fd")  ; cyan                                                                                         
      (set-face-foreground 'eat-term-color-7 "#f8f8f2")  ; white                                                                                        

      ;; Couleurs bright (8-15)                                                                                                                         
      (set-face-foreground 'eat-term-color-8 "#6272a4")   ; bright black (gris)                                                                         
      (set-face-foreground 'eat-term-color-9 "#ff6e6e")   ; bright red                                                                                  
      (set-face-foreground 'eat-term-color-10 "#69ff94")  ; bright green                                                                                
      (set-face-foreground 'eat-term-color-11 "#ffffa5")  ; bright yellow                                                                               
      (set-face-foreground 'eat-term-color-12 "#d6acff")  ; bright blue                                                                                 
      (set-face-foreground 'eat-term-color-13 "#ff92df")  ; bright magenta                                                                              
      (set-face-foreground 'eat-term-color-14 "#a4ffff")  ; bright cyan                                                                                 
      (set-face-foreground 'eat-term-color-15 "#ffffff")

      (setq eat-term-scrollback-size 400000
            eat--synchronize-scroll-function #'eat--synchronize-scroll)) ; bright white
    )
#+end_src
              
*** Aliases
#+begin_src emacs-lisp
  (defun eshell/emacs (file)
    (find-file file))
#+end_src

** Better term
#+begin_src emacs-lisp
  (use-package multi-term
    :bind (
           :map term-mode-map
           ("s-<escape>" . term-char-mode))
    :config
    (defun term-send-tab ()
      (interactive)
      (term-send-raw-string "\t"))

    (setq multi-term-program "bash")

    (add-to-list 'term-bind-key-alist '("<backtab>" . term-send-up))
    (add-to-list 'term-bind-key-alist '("TAB" . term-send-tab))
    (add-to-list 'term-bind-key-alist '("s-<escape>" . term-line-mode)))
#+end_src

** Coterm
#+begin_src emacs-lisp
  (use-package coterm
    :defer 3
    :config
    (coterm-mode))
#+end_src

** Detached
#+begin_src emacs-lisp
  (use-package detached
    :init
    (detached-init)
    :bind (;; Replace `async-shell-command' with `detached-shell-command'
           ([remap async-shell-command] . detached-shell-command)
           ;; Replace `compile' with `detached-compile'
           ([remap compile] . detached-compile)
           ([remap recompile] . detached-compile-recompile)
           ;; Replace built in completion of sessions with `consult'
           ([remap detached-open-session] . detached-consult-session))
    :custom ((detached-show-output-on-attach t)
             (detached-terminal-data-command system-type)))
#+end_src

** Fancy compilation
#+begin_src emacs-lisp
  (use-package fancy-compilation
    :commands (fancy-compilation-mode)
    :config
    (setq fancy-compilation-override-colors nil))

  (with-eval-after-load 'compile
    (fancy-compilation-mode))
#+end_src

* Dired
#+BEGIN_SRC emacs-lisp
  (defun dired/open-file ()
    "In dired, open the file named on this line."
    (interactive)
    (let* ((file (dired-get-filename nil t)))
      (message "Opening %s..." file)
      (call-process "xdg-open" nil 0 nil file)
      (message "Opening %s done" file)))

  (defun dired/open-home-dir ()
    "Open the home directory in dired"
    (interactive)
    (dired "~"))

  (defun dired/first-file ()
    (interactive)
    (beginning-of-buffer)
    (while (and (not (eobp))
                (or (bolp)
                    (member (dired-get-filename 'no-dir t)
                            '("." ".."))))
      (dired-next-line 1)))

  (defun dired/last-file ()
    (interactive)
    (end-of-buffer)
    (dired-next-line -1))
#+END_SRC

#+BEGIN_SRC emacs-lisp
  (use-package dired
    :ensure nil
    :bind (
           :map dired-mode-map
           ("C-." . dired-hide-dotfiles-mode)
           ("<C-return>" . dired/open-file)
           ("M-p" . dired-up-directory)
           ("M-n" . dired-find-file)
           ("s-<escape>" . dired-toggle-read-only)
           ("M-<" . dired/first-file)
           ("M->" . dired/last-file)
           ("~" . dired/open-home-dir))
    :hook
    (dired-mode . dired-hide-details-mode)
    :config
    (setq ls-lisp-use-insert-directory-program nil)
    (require 'ls-lisp)
    (setq ls-lisp-dirs-first t
          wdired-allow-to-change-permissions t
          dired-auto-revert-buffer t)
    (add-hook 'wdired-mode-hook
              (lambda ()
                (define-key wdired-mode-map (kbd "s-<escape>") 'wdired-abort-changes))))

  (use-package dired-hide-dotfiles
    :hook
    (dired-mode . dired-hide-dotfiles-mode))

  (use-package nerd-icons-dired
    :hook
    (dired-mode . nerd-icons-dired-mode))
#+END_SRC

* Internet
** Default browser
#+BEGIN_SRC emacs-lisp
  (defun browse/url-zen-open (url &optional _ignored)
    (interactive (browse-url-interactive-arg "URL: "))
    (call-process "zen" nil 0 nil "--new-window" url))

  (defun browse/url-vivaldi-open (url &optional _ignored)
    (interactive (browse-url-interactive-arg "URL: "))
    (call-process "vivaldi" nil 0 nil "--new-window" url))

  (setq browse-url-browser-function 'browse/url-vivaldi-open)
#+END_SRC

** HTML viewer
#+BEGIN_SRC emacs-lisp
  (use-package shr
    :ensure nil
    :config
    (setq shr-use-fonts t)
    (setq shr-use-colors nil)
    (setq shr-inhibit-images nil)
    (setq shr-max-image-proportion 0.9)
    (setq shr-width nil)
    (setq shr-folding-mode t)
    (setq shr-width -1))

  (use-package shr-tag-pre-highlight
    :after shr
    :config
    (add-to-list 'shr-external-rendering-functions
                 '(pre . shr-tag-pre-highlight)))
#+END_SRC

** Emacs Web Wowser
#+BEGIN_SRC emacs-lisp
  (global-set-key (kbd "M-s i") 'eww)

  (use-package eww
    :ensure nil
    :bind (:map eww-mode-map
                ("M-p" . eww-back-url)
                ("M-p" . eww-next-url)
                ("C-|" . eww-browse-with-external-browser)
                ("C-c g" . eww-reload))
    :config
    (defvar eww/input-history nil)
    (eval-after-load "savehist"
      '(add-to-list 'savehist-additional-variables 'eww/input-history))

    (defun eww/do-start-with-url-or-search ()
      (interactive)
      (if (derived-mode-p 'eww-mode)
          (eww (completing-read "Eww URL or search " eww/input-history nil nil (eww-current-url) 'eww/input-history))
        (eww (completing-read "Eww URL or search " eww/input-history nil nil nil 'eww/input-history))))

    (setq eww-search-prefix "https://duckduckgo.com/html/?q=")
    (with-eval-after-load 'eww
      (defun eww/rename-buffer ()
        "Rename `eww-mode' buffer so sites open in new page.
      URL `http://xahlee.info/emacs/emacs/emacs_eww_web_browser.html'
      Version 2017-11-10"
        (interactive)
        (let (($title (plist-get eww-data :title)))
          (when (eq major-mode 'eww-mode )
            (if $title
                (rename-buffer (concat "Eww: " $title) t)
              (rename-buffer "Eww" t)))))

      (add-hook 'eww-after-render-hook #'mixed-pitch-mode)
      (add-hook 'eww-after-render-hook 'eww/rename-buffer)
      (add-hook 'eww-after-render-hook (lambda () (visual-line-mode 1)))))
#+END_SRC

* Local settings
Sometimes, settings are specific to one of my computers. Those settings are stored in a local.el file. This file is not under a version control system.
#+BEGIN_SRC emacs-lisp
  (add-hook 'after-init-hook
      #'(lambda ()
  	(let ((local-settings "~/.emacs.d/local.el"))
  	  (when (file-exists-p local-settings)
  	    (load-file local-settings)))
      (lsp)
      (fix-char-width-for-spinners)))
#+END_SRC
